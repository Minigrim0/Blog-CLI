stages:
  - test
  - deploy

variables:
  CARGO_REGISTRY_TOKEN: $CARGO_REGISTRY_TOKEN

unit-test-job:
  stage: test
  tags:
    - rust
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+\-release/'
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+\-rc\d+/'
  script:
    - cargo test

linting-test-job:
  before_script:
    - rustup component add clippy
    - rustup component add rustfmt
  tags:
    - rust
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+\-release/'
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+\-rc\d+/'
  script:
    - cargo fmt --all -- --check
    - cargo clippy -- --deny clippy::pedantic

deploy-job:
  stage: deploy
  tags:
    - rust
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+\-release/'
  environment: production
  script:
    - cargo publish --token $CARGO_REGISTRY_TOKEN
